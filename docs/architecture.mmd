graph TB
    subgraph "Client Layer"
        User[User/Browser]
    end

    subgraph "Ephemeral Application Layer - Dev-Local/Green"
        subgraph "Frontend Layer"
            React[React Frontend<br/>HTTPS Port 3443/3543<br/>Registration/Login/Orders UI]
        end

        subgraph "API Layer"
            API[API Gateway<br/>HTTPS Port 3001/3101<br/>Express + JWT Auth]
            Auth[Auth Routes<br/>/api/auth/register<br/>/api/auth/login]
            Orders[Order Routes<br/>/api/orders<br/>JWT Protected]
        end

        subgraph "AWS Services - Localstack"
            SQS[SQS Queue<br/>order-processing-queue<br/>Async Message Queue<br/>Port 4566/4666]
            DLQ[Dead Letter Queue<br/>order-processing-dlq]
            KMS[KMS Key<br/>Database Encryption<br/>Key Rotation Enabled]
            Secrets[Secrets Manager<br/>DB Credentials<br/>KMS Encrypted]
        end

        subgraph "Processing Layer"
            Processor[Order Processor<br/>Background Service<br/>Node.js Microservice]
        end
    end

    subgraph "Durable Infrastructure Layer - Persists Across Deployments"
        subgraph "Load Balancer"
            Nginx[nginx<br/>Reverse Proxy<br/>Blue-Green Traffic Routing<br/>Basic Auth for Observability UIs]
        end

        subgraph "Data Layer"
            MariaDBDev[(Dev-Local Database<br/>echobase-durable-mariadb<br/>Port 3306<br/>orders_db<br/>Encryption at Rest)]
            MariaDBCI[(CI Database<br/>echobase-ci-durable-mariadb<br/>Port 3307<br/>orders_db<br/>Encryption at Rest)]
        end

        subgraph "Observability Stack"
            OTELCollector[OTEL Collector<br/>Receives OTLP telemetry<br/>gRPC :4317 / HTTP :4318]
            Prometheus[Prometheus<br/>Metrics Storage<br/>/prometheus/]
            Jaeger[Jaeger<br/>Distributed Tracing<br/>/jaeger/]
            Loki[Loki<br/>Log Aggregation<br/>/loki/]
            Grafana[Grafana<br/>Unified Dashboard<br/>/grafana/]
        end

        subgraph "Database Schema"
            Users[Users Table<br/>id, username, email<br/>full_name, password_hash]
            OrdersTable[Orders Table<br/>id, user_id, product_name<br/>quantity, total_price, status]
        end
    end

    subgraph "Infrastructure Management"
        Terraform[Terraform<br/>Provisions AWS Resources<br/>SQS, KMS, Secrets Manager]
        DurableSetup[Durable Infrastructure<br/>./durable/setup.sh<br/>dev-local or ci]
        AppDocker[Application Docker Compose<br/>Blue-Green Deployment<br/>Ephemeral Services]
    end

    User -->|1. Register/Login| React
    React -->|2. POST /api/auth/register<br/>POST /api/auth/login| Auth
    Auth -->|3. Retrieves Credentials| Secrets
    Secrets -->|Encrypted| KMS
    Auth -->|4. Creates User| Users
    Auth -->|5. Returns JWT Token| React

    User -->|6. Places Order| React
    React -->|7. POST /api/orders<br/>Authorization: Bearer JWT| Orders
    Orders -->|8. Validates JWT| Orders
    Orders -->|9. Sends Message<br/>with user_id| SQS

    SQS -.->|Failed Messages| DLQ
    Processor -->|10. Retrieves Credentials| Secrets
    Processor -->|11. Long Polls| SQS
    Processor -->|12. Deletes Message| SQS
    Processor -->|13. INSERT Order<br/>with user_id| OrdersTable

    OrdersTable -.->|Foreign Key| Users
    Users -.->|Belongs To| MariaDBDev
    Users -.->|Belongs To| MariaDBCI
    OrdersTable -.->|Belongs To| MariaDBDev
    OrdersTable -.->|Belongs To| MariaDBCI

    Terraform -.->|Provisions| SQS
    Terraform -.->|Provisions| DLQ
    Terraform -.->|Creates| KMS
    Terraform -.->|Creates| Secrets

    DurableSetup -.->|Creates & Manages| MariaDBDev
    DurableSetup -.->|Creates & Manages| MariaDBCI
    DurableSetup -.->|Creates & Manages| OTELCollector
    DurableSetup -.->|Creates & Manages| Nginx

    AppDocker -.->|Runs Ephemeral| React
    AppDocker -.->|Runs Ephemeral| API
    AppDocker -.->|Runs Ephemeral| Processor
    AppDocker -.->|Runs Ephemeral| SQS

    Auth -.->|Connects via<br/>durable-network| MariaDBDev
    Auth -.->|Connects via<br/>durable-ci-network| MariaDBCI
    Processor -.->|Connects via<br/>durable-network| MariaDBDev
    Processor -.->|Connects via<br/>durable-ci-network| MariaDBCI

    React -.->|Traces (OTLP)| OTELCollector
    API -.->|Traces, Metrics,<br/>Logs (OTLP)| OTELCollector
    Processor -.->|Traces, Metrics,<br/>Logs (OTLP)| OTELCollector
    OTELCollector -->|Traces| Jaeger
    OTELCollector -->|Metrics| Prometheus
    OTELCollector -->|Logs| Loki
    Grafana -.->|Queries| Prometheus
    Grafana -.->|Queries| Loki
    Grafana -.->|Queries| Jaeger
    Nginx -.->|Proxies /grafana/,<br/>/prometheus/, /jaeger/,<br/>/loki/| Grafana

    style User fill:#e1f5ff
    style React fill:#61dafb
    style API fill:#68a063
    style Auth fill:#90EE90
    style Orders fill:#90EE90
    style SQS fill:#ff9900
    style DLQ fill:#ff9900
    style KMS fill:#ff6b6b
    style Secrets fill:#ffd93d
    style Processor fill:#68a063
    style MariaDBDev fill:#003545
    style MariaDBCI fill:#003545
    style Users fill:#4a90e2
    style OrdersTable fill:#4a90e2
    style Terraform fill:#7b42bc
    style DurableSetup fill:#7b42bc
    style AppDocker fill:#2496ed
    style Nginx fill:#009639
    style OTELCollector fill:#f5a623
    style Prometheus fill:#e6522c
    style Jaeger fill:#60d0e4
    style Loki fill:#f2994a
    style Grafana fill:#f46800
