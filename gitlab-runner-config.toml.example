# GitLab Runner Configuration for Blue-Green Deployment
#
# This configuration enables PERSISTENT CONTAINERS across CI jobs,
# which is required for blue-green deployment where:
#   1. deploy:green creates the green environment
#   2. test:green-e2e tests it (containers must still be running)
#   3. promote:green switches traffic (green becomes production)
#
# CRITICAL: Uses host Docker socket instead of Docker-in-Docker (DinD)
# so containers persist across jobs on the same runner.
#
# Configuration file locations:
#   - macOS: ~/.gitlab-runner/config.toml
#   - Linux: /etc/gitlab-runner/config.toml
#
# After editing, restart the runner:
#   - macOS: gitlab-runner restart
#   - Linux: sudo gitlab-runner restart

concurrent = 1  # Number of jobs that can run concurrently
check_interval = 3  # How often to check for new jobs (seconds)

# Session server for interactive debugging (optional)
[session_server]
  session_timeout = 1800

# Runner configuration
[[runners]]
  name = "Local Development Runner"  # Your runner name
  url = "https://gitlab.com"  # Your GitLab instance URL
  token = "YOUR_RUNNER_TOKEN_HERE"  # Token from registration (auto-generated)
  executor = "docker"  # Use Docker executor

  # IMPORTANT: Tags must match jobs in .gitlab-ci.yml
  # Jobs with tags: [docker-local] will run on this runner
  tags = ["docker-local"]

  # Only run jobs with matching tags (recommended for blue-green)
  run_untagged = false

  # Number of concurrent jobs this runner can handle
  request_concurrency = 2

  # Docker executor configuration
  [runners.docker]
    # Default image for jobs (can be overridden in .gitlab-ci.yml)
    # NOTE: Using docker:24 (not docker:24-dind) because we mount host socket
    image = "docker:24"

    # IMPORTANT: privileged = false for blue-green deployment
    # We use host Docker socket, not Docker-in-Docker, so don't need privileged
    privileged = false

    # Disable TLS verification for local development
    tls_verify = false

    # Don't override entrypoint
    disable_entrypoint_overwrite = false

    # Don't disable OOM killer
    oom_kill_disable = false

    # Enable caching
    disable_cache = false

    # CRITICAL: Volumes configuration for persistent containers
    # This is the KEY to making blue-green deployment work!
    volumes = [
      # Mount host Docker socket - containers persist across jobs
      "/var/run/docker.sock:/var/run/docker.sock",
      # Cache directory for GitLab Runner
      "/cache"
    ]

    # Shared memory size (0 = use default)
    shm_size = 0

    # Network mode (default)
    network_mode = "bridge"

    # Pull policy for Docker images
    pull_policy = ["if-not-present"]

    # Docker DNS settings (optional)
    # dns = ["8.8.8.8", "8.8.4.4"]

    # Extra hosts (optional)
    # extra_hosts = ["somehost:162.242.195.82"]

    # Environment variables (optional)
    # environment = ["ENV=value", "LC_ALL=en_US.UTF-8"]

    # CPU and memory limits (optional)
    # cpus = "1.0"
    # memory = "2g"
    # memory_swap = "3g"
    # memory_reservation = "1g"

  # Cache configuration (optional)
  [runners.cache]
    # Cache type (optional: s3, gcs, azure)
    # Type = "s3"
    # Path = "cache"
    # Shared = false

    # [runners.cache.s3]
    #   ServerAddress = "s3.amazonaws.com"
    #   BucketName = "gitlab-runner-cache"
    #   BucketLocation = "us-east-1"

# Example: Multiple runners configuration
# [[runners]]
#   name = "Production Runner"
#   url = "https://gitlab.com"
#   token = "ANOTHER_TOKEN"
#   executor = "docker"
#   [runners.docker]
#     image = "docker:24-dind"
#     privileged = true
#     volumes = ["/var/run/docker.sock:/var/run/docker.sock", "/cache"]

# Configuration notes:
#
# 1. Token Security:
#    - The token is automatically generated during registration
#    - Keep this file secure (permissions: 600)
#    - Never commit config.toml to version control
#
# 2. Privileged Mode (FALSE for blue-green):
#    - NOT required when using host Docker socket
#    - privileged = true is only needed for true Docker-in-Docker
#    - Blue-green deployment uses host socket, so privileged = false
#    - This is more secure and performs better
#
# 3. Docker Socket Mounting (CRITICAL for blue-green):
#    - Mounts host Docker daemon socket into containers
#    - All jobs share the SAME Docker daemon on the host
#    - Containers created in deploy:green persist for test:green-e2e
#    - This enables the blue-green deployment pattern
#    - Called "Docker-out-of-Docker" (DooD)
#
# 4. Why This Matters for Blue-Green:
#    - deploy:green creates green environment → containers run on host
#    - test:green-e2e tests green → same containers still running
#    - promote:green switches traffic → green becomes production
#    - cleanup:blue removes old blue → manual cleanup when safe
#
#    Without socket mount, each job gets isolated DinD daemon:
#    - deploy:green: DinD #1 → containers created → job ends → containers DESTROYED
#    - test:green-e2e: DinD #2 → NEW daemon → NO CONTAINERS → FAILS!
#
# 4. Volume Mounting:
#    - Format: "host-path:container-path:options"
#    - Options: ro (read-only), rw (read-write)
#    - Example: "/data:/app/data:ro"
#
# 5. Resource Limits:
#    - Uncomment cpus/memory settings to limit resource usage
#    - Prevents CI jobs from consuming all host resources
#    - Recommended for production runners
#
# 6. Concurrent Jobs:
#    - Set concurrent = N to run N jobs in parallel
#    - Each job runs in a separate container
#    - Be mindful of host resources
#
# 7. Tags (IMPORTANT):
#    - Jobs with matching tags will run on this runner
#    - deploy:green and test:green-e2e MUST use same tag (e.g., "docker-local")
#    - This ensures they run on same runner = same Docker daemon = containers persist
#    - Multiple runners can have same tags (jobs distributed)
#    - Use specific tags for different environments (dev, staging, prod)

# Troubleshooting:
#
# - Runner not picking up jobs:
#   Check token is valid, runner is started, and tags match
#
# - Docker permission errors:
#   Ensure privileged = true and Docker socket is mounted
#
# - Out of memory errors:
#   Uncomment and set memory limits in [runners.docker]
#
# - Slow image pulls:
#   Use pull_policy = ["if-not-present"] to avoid unnecessary pulls
#
# - Network issues:
#   Add custom DNS servers or extra_hosts as needed

# Additional Resources:
# - GitLab Runner docs: https://docs.gitlab.com/runner/
# - Configuration reference: https://docs.gitlab.com/runner/configuration/advanced-configuration.html
# - Docker executor: https://docs.gitlab.com/runner/executors/docker.html
