# Terraform Configuration

This directory contains Terraform configuration for provisioning AWS resources in Localstack.

## Resources Created

1. **KMS Key** (`kms.tf`) - Customer-managed encryption key for database secrets in Secrets Manager
   - Only created in durable environments (devlocal, ci)
   - Not used for SQS encryption
2. **Secrets Manager** (`secrets.tf`) - Secure storage for database credentials
   - Encrypted with KMS key
   - Only created in durable environments
3. **SQS Queues** (`sqs.tf`) - Message queues for order processing
   - Uses SSE-SQS (AWS managed encryption)
   - Created in all environments (durable and ephemeral)
4. **IAM Policies** (`secrets.tf`) - Access policies for secrets

## Security Best Practices

### No Hardcoded Credentials

Database credentials are **not hardcoded** in Terraform files. Instead, they are:

1. Generated by `scripts/generate-credentials.sh` and stored in the root `.env` file
2. Read by Terraform as environment variables at apply time
3. Stored securely in AWS Secrets Manager (encrypted with KMS)

This approach ensures:
- ✅ Secrets are never committed to version control
- ✅ Terraform state doesn't contain plaintext passwords (marked as sensitive)
- ✅ Different environments can use different credentials
- ✅ Credentials can be rotated without modifying Terraform code

## Usage

### Automated (Recommended)

The `setup.sh` script automatically exports the necessary variables:

```bash
cd /Users/tadk/work/echobase
./setup.sh
```

### Manual

If running Terraform manually, export the database variables first:

```bash
cd terraform

# Load variables from .env file
source ../.env

# Export as Terraform variables (TF_VAR_* prefix)
export TF_VAR_db_user=$DB_USER
export TF_VAR_db_password=$DB_PASSWORD
export TF_VAR_db_host=$DB_HOST
export TF_VAR_db_port=$DB_PORT
export TF_VAR_db_name=$DB_NAME

# Initialize and apply
terraform init
terraform apply
```

### One-Line Command

```bash
TF_VAR_db_user=$DB_USER \
TF_VAR_db_password=$DB_PASSWORD \
TF_VAR_db_host=$DB_HOST \
TF_VAR_db_port=$DB_PORT \
TF_VAR_db_name=$DB_NAME \
terraform apply -auto-approve
```

## Variables

All variables are defined in `variables.tf`:

| Variable | Description | Required | Sensitive | Default |
|----------|-------------|----------|-----------|---------|
| `db_host` | Database hostname | No | No | `mariadb` |
| `db_port` | Database port | No | No | `3306` |
| `db_name` | Database name | No | No | `orders_db` |
| `db_user` | Database username | **Yes** | **Yes** | - |
| `db_password` | Database password | **Yes** | **Yes** | - |

### Sensitive Variables

The `db_user` and `db_password` variables are marked as `sensitive = true`, which means:
- Values are not displayed in Terraform output
- Values are redacted in Terraform plan/apply logs
- Values are encrypted in Terraform state

## Outputs

After applying, Terraform provides these outputs:

```bash
terraform output
```

Available outputs:
- `kms_key_id` - KMS key ID for database secrets encryption (durable environments only)
- `kms_key_arn` - KMS key ARN (durable environments only)
- `secret_arn` - Secrets Manager ARN (durable environments only)
- `secret_name` - Secrets Manager secret name (durable environments only)
- `sqs_queue_url` - SQS queue URL (all environments)
- `sqs_queue_arn` - SQS queue ARN (all environments)
- `sqs_dlq_url` - Dead letter queue URL (all environments)
- `sqs_dlq_arn` - Dead letter queue ARN (all environments)

**Note**: In ephemeral environments (green, blue), KMS and Secrets outputs will show "not-created-in-ephemeral-env"

## Verifying Secrets

To verify the secret was created correctly:

```bash
# List all secrets
docker exec echobase-devlocal-localstack awslocal secretsmanager list-secrets

# Get secret value
docker exec echobase-devlocal-localstack awslocal secretsmanager get-secret-value \
  --secret-id echobase/database/credentials
```

## Production Considerations

### For Production AWS Deployment:

1. **Use Real AWS Credentials**
   - Replace Localstack endpoint with real AWS
   - Use IAM roles instead of access keys
   - Enable MFA for sensitive operations

2. **Enable Secret Rotation**
   - Uncomment rotation configuration in `secrets.tf`
   - Configure Lambda rotation function
   - Test rotation process thoroughly

3. **Use RDS Instead of Docker**
   - Replace MariaDB container with RDS instance
   - Enable Multi-AZ for high availability
   - Enable automated backups

4. **Secure Terraform State**
   - Use remote backend (S3 + DynamoDB)
   - Enable state file encryption
   - Implement state locking

5. **Implement Least Privilege**
   - Review and restrict IAM policies
   - Use separate AWS accounts per environment
   - Enable CloudTrail for audit logging

## Troubleshooting

### Missing Variables Error

```
Error: No value for required variable
  on variables.tf line X:
   X: variable "db_password" {
```

**Solution:** Ensure you've exported the `TF_VAR_*` environment variables before running Terraform.

### Secret Already Exists

If you get an error that the secret already exists, you can:

1. Import existing secret:
   ```bash
   terraform import aws_secretsmanager_secret.db_credentials echobase/database/credentials
   ```

2. Or destroy and recreate:
   ```bash
   terraform destroy -target=aws_secretsmanager_secret_version.db_credentials
   terraform apply
   ```

### Localstack Connection Issues

If Terraform can't connect to Localstack:

1. Verify Localstack is running:
   ```bash
   docker compose ps localstack
   ```

2. Check Localstack logs:
   ```bash
   docker compose logs localstack
   ```

3. Test endpoint connectivity:
   ```bash
   curl http://localhost:4566/_localstack/health
   ```

## Files

- `main.tf` - Provider configuration (AWS/Localstack)
- `variables.tf` - Variable definitions (no default values for sensitive vars)
- `kms.tf` - KMS encryption key configuration
- `secrets.tf` - Secrets Manager configuration
- `sqs.tf` - SQS queue configuration
- `.terraform/` - Terraform plugins and modules (gitignored)
- `terraform.tfstate` - Terraform state file (gitignored)

## Security Notes

⚠️ **Important:**
- Never commit `.tfstate` files to version control
- Never hardcode credentials in `.tf` files
- Always use `sensitive = true` for passwords
- Review Terraform plans before applying
- Use separate credentials per environment
- Rotate credentials regularly

✅ **This Configuration:**
- Reads credentials from environment variables
- Marks sensitive variables appropriately
- Stores secrets encrypted with KMS
- Uses IAM policies for access control
- Follows AWS security best practices
