# Durable Infrastructure for Echobase
# This infrastructure persists across blue-green deployments
# Usage:
#   Dev-Local: docker compose -f durable/docker-compose.yml -p echobase-devlocal-durable up -d
#   CI:        docker compose -f durable/docker-compose.yml -p echobase-ci-durable up -d
#
# Environment variables (set via .env file):
#   MYSQL_ROOT_PASSWORD - Root password for MariaDB
#   MYSQL_DATABASE - Database name
#   MYSQL_USER - Application database user
#   MYSQL_PASSWORD - Application database password
#   AWS_ACCESS_KEY_ID - AWS access key for LocalStack
#   AWS_SECRET_ACCESS_KEY - AWS secret key for LocalStack
#   AWS_REGION - AWS region (default: us-east-1)
#   DURABLE_ENV - Environment name (devlocal or ci)

services:
  localstack:
    image: localstack/localstack:latest
    container_name: ${DURABLE_CONTAINER_PREFIX:-echobase-durable}-localstack
    environment:
      - SERVICES=secretsmanager,kms
      - DEBUG=1
      - PERSISTENCE=1
    volumes:
      - localstack-data:/var/lib/localstack
    networks:
      - durable-network
    ports:
      - "${DURABLE_LOCALSTACK_PORT:-4566}:4566"  # Dev-local: 4566, CI: 4567
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 5s
      timeout: 3s
      retries: 40
      start_period: 20s
    restart: unless-stopped

  mariadb:
    build:
      context: ..
      dockerfile: mariadb/Dockerfile
    image: echobase-mariadb:latest
    container_name: ${DURABLE_CONTAINER_PREFIX:-echobase-durable}-mariadb
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - mariadb-data:/var/lib/mysql
    networks:
      - durable-network
    ports:
      - "${DURABLE_DB_PORT:-3306}:3306"
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "127.0.0.1", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 3s
      timeout: 3s
      retries: 40
      start_period: 30s
    restart: unless-stopped

volumes:
  localstack-data:
    name: ${DURABLE_VOLUME_PREFIX:-echobase-durable}-localstack-data
  mariadb-data:
    name: ${DURABLE_VOLUME_PREFIX:-echobase-durable}-mariadb-data

networks:
  durable-network:
    name: ${DURABLE_NETWORK_NAME:-echobase-durable-network}
    driver: bridge
