# Durable Infrastructure for Echobase
# This infrastructure persists across blue-green deployments
# Usage:
#   Dev-Local: docker compose -f durable/docker-compose.yml -p echobase-devlocal-durable up -d
#   CI:        docker compose -f durable/docker-compose.yml -p echobase-ci-durable up -d
#
# Environment variables (set via .env file):
#   MYSQL_ROOT_PASSWORD - Root password for MariaDB
#   MYSQL_DATABASE - Database name
#   MYSQL_USER - Application database user
#   MYSQL_PASSWORD - Application database password
#   AWS_ACCESS_KEY_ID - AWS access key for LocalStack
#   AWS_SECRET_ACCESS_KEY - AWS secret key for LocalStack
#   AWS_REGION - AWS region (default: us-east-1)
#   DURABLE_ENV - Environment name (devlocal or ci)

services:
  localstack:
    image: localstack/localstack:latest
    container_name: ${DURABLE_CONTAINER_PREFIX:-echobase-durable}-localstack
    environment:
      - SERVICES=secretsmanager,kms
      - DEBUG=0
      - PERSISTENCE=1
    volumes:
      - localstack-data:/var/lib/localstack
    networks:
      - durable-network
    ports:
      - "${DURABLE_LOCALSTACK_PORT:-4566}:4566"  # Dev-local: 4566, CI: 4567
    labels:
      - "echobase.role=durable"
      - "echobase.env=${DURABLE_ENV:-devlocal}"
      - "echobase.service=localstack"
      - "echobase.port=${DURABLE_LOCALSTACK_PORT:-4566}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 5s
      timeout: 3s
      retries: 40
      start_period: 20s
    restart: unless-stopped

  mariadb:
    build:
      context: ..
      dockerfile: mariadb/Dockerfile
    image: echobase-mariadb:latest
    container_name: ${DURABLE_CONTAINER_PREFIX:-echobase-durable}-mariadb
    # Give MariaDB 5 minutes to flush InnoDB buffers on shutdown (default is 10s)
    # This prevents database corruption from abrupt stops
    # Use ./stop.sh --all for cleaner shutdown (sends mysqladmin shutdown first)
    stop_grace_period: 5m
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      # AWS credentials for fetching encryption key from Secrets Manager
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-test}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-test}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      # Secrets Manager endpoint (durable LocalStack)
      - SECRETS_MANAGER_ENDPOINT=http://${DURABLE_CONTAINER_PREFIX:-echobase-durable}-localstack:4566
    volumes:
      - mariadb-data:/var/lib/mysql
    networks:
      - durable-network
    ports:
      - "${DURABLE_DB_PORT:-3306}:3306"
    depends_on:
      localstack:
        condition: service_healthy
    labels:
      - "echobase.role=durable"
      - "echobase.env=${DURABLE_ENV:-devlocal}"
      - "echobase.service=mariadb"
      - "echobase.port=${DURABLE_DB_PORT:-3306}"
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "127.0.0.1", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 3s
      timeout: 3s
      retries: 40
      start_period: 30s
    restart: unless-stopped

  mcp-server:
    build:
      context: ..
      dockerfile: backend/mcp-server/Dockerfile
    image: echobase-mcp-server:latest
    container_name: ${DURABLE_CONTAINER_PREFIX:-echobase-durable}-mcp-server
    environment:
      - PORT=3002
      - MCP_API_KEY=${MCP_API_KEY}
    networks:
      - durable-network
    ports:
      - "${DURABLE_MCP_SERVER_PORT:-3002}:3002"
    labels:
      - "echobase.role=durable"
      - "echobase.env=${DURABLE_ENV:-devlocal}"
      - "echobase.service=mcp-server"
      - "echobase.port=${DURABLE_MCP_SERVER_PORT:-3002}"
    healthcheck:
      test: ["CMD", "node", "-e", "const http = require('http'); http.get({host:'127.0.0.1',port:3002,path:'/health'}, (r) => {process.exit(r.statusCode === 200 ? 0 : 1)}).on('error', () => process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  nginx:
    build:
      context: ..
      dockerfile: durable/nginx/Dockerfile
    image: echobase-nginx:latest
    container_name: ${DURABLE_CONTAINER_PREFIX:-echobase-durable}-nginx
    environment:
      # AWS credentials for fetching SSL certs from Secrets Manager
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-test}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-test}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      # Secrets Manager endpoint (durable LocalStack)
      - AWS_ENDPOINT_URL=http://${DURABLE_CONTAINER_PREFIX:-echobase-durable}-localstack:4566
      # SSL setup (shared 40-ssl-setup.sh script)
      - SSL_SECRET_ID=echobase/nginx-lb/ssl
      - SSL_DIR=/etc/ssl
      # HTTP basic auth for observability UIs (Prometheus, Jaeger, Grafana, Loki)
      - HTPASSWD_CONTENTS=${HTPASSWD_CONTENTS:-}
    volumes:
      - nginx-config:/etc/nginx/conf.d  # Persist nginx config across restarts
    networks:
      - durable-network  # Blue and green connect to durable-network, so nginx can reach them
    ports:
      - "${DURABLE_NGINX_HTTP_PORT:-80}:80"      # Dev-local: 80, CI: 180
      - "${DURABLE_NGINX_HTTPS_PORT:-443}:443"   # Dev-local: 443, CI: 1443
      - "${DURABLE_NGINX_BLUE_PORT:-8080}:8080"  # Dev-local: 8080, CI: 8180
      - "${DURABLE_NGINX_GREEN_PORT:-8081}:8081" # Dev-local: 8081, CI: 8181
    labels:
      - "echobase.role=durable"
      - "echobase.env=${DURABLE_ENV:-devlocal}"
      - "echobase.service=nginx"
      - "echobase.nginx.http_port=${DURABLE_NGINX_HTTP_PORT:-80}"
      - "echobase.nginx.https_port=${DURABLE_NGINX_HTTPS_PORT:-443}"
      - "echobase.nginx.blue_port=${DURABLE_NGINX_BLUE_PORT:-8080}"
      - "echobase.nginx.green_port=${DURABLE_NGINX_GREEN_PORT:-8081}"
    depends_on:
      localstack:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 3s
      retries: 3

  otel-collector:
    build:
      context: ../otel
      dockerfile: Dockerfile.collector
    image: echobase-otel-collector:latest
    container_name: ${DURABLE_CONTAINER_PREFIX:-echobase-durable}-otel-collector
    command: ["--config=/etc/otelcol/config.yaml"]
    networks:
      - durable-network
    ports:
      - "${DURABLE_OTEL_GRPC_PORT:-4317}:4317"
      - "${DURABLE_OTEL_HTTP_PORT:-4318}:4318"
    labels:
      - "echobase.role=durable"
      - "echobase.env=${DURABLE_ENV:-devlocal}"
      - "echobase.service=otel-collector"
    # Note: The contrib image is distroless (no wget/curl). The health_check
    # extension listens on 13133 but we can't probe it from inside the container.
    # Instead we use a TCP connect test via the collector's own gRPC port.
    healthcheck:
      test: ["CMD", "/otelcol-contrib", "validate", "--config=/etc/otelcol/config.yaml"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  jaeger:
    build:
      context: ../otel
      dockerfile: Dockerfile.jaeger
    image: echobase-jaeger:latest
    container_name: ${DURABLE_CONTAINER_PREFIX:-echobase-durable}-jaeger
    command: ["--config", "/etc/jaeger/config.yaml"]
    environment:
      - BADGER_DIRECTORY_VALUE=/badger/data
      - BADGER_DIRECTORY_KEY=/badger/key
    volumes:
      - jaeger-badger-data:/badger
    networks:
      - durable-network
    labels:
      - "echobase.role=durable"
      - "echobase.env=${DURABLE_ENV:-devlocal}"
      - "echobase.service=jaeger"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:13133/status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  prometheus:
    build:
      context: ../otel
      dockerfile: Dockerfile.prometheus
    image: echobase-prometheus:latest
    container_name: ${DURABLE_CONTAINER_PREFIX:-echobase-durable}-prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--web.enable-remote-write-receiver"
      - "--storage.tsdb.path=/prometheus"
      - "--web.external-url=/prometheus/"
    volumes:
      - prometheus-data:/prometheus
    networks:
      - durable-network
    depends_on:
      otel-collector:
        condition: service_healthy
    labels:
      - "echobase.role=durable"
      - "echobase.env=${DURABLE_ENV:-devlocal}"
      - "echobase.service=prometheus"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/prometheus/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  loki:
    build:
      context: ../otel
      dockerfile: Dockerfile.loki
    image: echobase-loki:latest
    container_name: ${DURABLE_CONTAINER_PREFIX:-echobase-durable}-loki
    volumes:
      - loki-data:/loki
    networks:
      - durable-network
    labels:
      - "echobase.role=durable"
      - "echobase.env=${DURABLE_ENV:-devlocal}"
      - "echobase.service=loki"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3100/ready"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  grafana:
    build:
      context: ../otel
      dockerfile: Dockerfile.grafana
    image: echobase-grafana:latest
    container_name: ${DURABLE_CONTAINER_PREFIX:-echobase-durable}-grafana
    environment:
      - GF_SERVER_ROOT_URL=%(protocol)s://%(domain)s/grafana/
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_DISABLE_LOGIN_FORM=true
    volumes:
      - grafana-data:/var/lib/grafana
    networks:
      - durable-network
    depends_on:
      prometheus:
        condition: service_healthy
      loki:
        condition: service_healthy
    labels:
      - "echobase.role=durable"
      - "echobase.env=${DURABLE_ENV:-devlocal}"
      - "echobase.service=grafana"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/grafana/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

volumes:
  localstack-data:
    name: ${DURABLE_VOLUME_PREFIX:-echobase-durable}-localstack-data
  mariadb-data:
    name: ${DURABLE_VOLUME_PREFIX:-echobase-durable}-mariadb-data
  nginx-config:
    name: ${DURABLE_VOLUME_PREFIX:-echobase-durable}-nginx-config
  jaeger-badger-data:
    name: ${DURABLE_VOLUME_PREFIX:-echobase-durable}-jaeger-badger-data
  prometheus-data:
    name: ${DURABLE_VOLUME_PREFIX:-echobase-durable}-prometheus-data
  loki-data:
    name: ${DURABLE_VOLUME_PREFIX:-echobase-durable}-loki-data
  grafana-data:
    name: ${DURABLE_VOLUME_PREFIX:-echobase-durable}-grafana-data

networks:
  durable-network:
    name: ${DURABLE_NETWORK_NAME:-echobase-durable-network}
    driver: bridge
