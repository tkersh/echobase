# IMPORTANT: This docker-compose.yml is for ephemeral blue-green deployments.
# The database is managed separately in durable/docker-compose.yml
# Before using this file, ensure the durable infrastructure is running:
#   ./durable/setup.sh devlocal

services:
  localstack:
    container_name: echobase-devlocal-localstack
    image: localstack/localstack:latest
    mem_limit: 1536m
    cpus: 1.0
    environment:
      # Ephemeral LocalStack only needs SQS.
      # Secrets Manager and KMS live in the durable LocalStack.
      - SERVICES=sqs
      - DEBUG=0
      - LS_LOG=warning
      - PERSISTENCE=1
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - "localstack-data:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
    networks:
      - echobase-network
    labels:
      - "echobase.role=ephemeral"
      - "echobase.env=devlocal"
      - "echobase.service=localstack"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://127.0.0.1:4566/_localstack/health" ]
      interval: 5s
      timeout: 10s
      retries: 15
      start_period: 20s

  api-gateway:
    container_name: echobase-devlocal-api-gateway
    mem_limit: 512m
    cpus: 0.5
    build:
      context: ./backend
      dockerfile: api-gateway/Dockerfile
      args:
        - GIT_SHORT_SHA=${GIT_SHORT_SHA:-unknown}
        - BUILD_DATE=${BUILD_DATE:-unknown}
    image: echobase-api-gateway:latest
    env_file:
      - .env
      - .env.secrets
    environment:
      # Per-service overrides only — everything else comes from env_file
      # CORS_ORIGIN default is in .env; overridden per-environment in override.yml, blue.yml, green.yml
      - OTEL_SERVICE_NAME=api-gateway
    depends_on:
      localstack:
        condition: service_healthy
    networks:
      - echobase-network
      - durable-network
    labels:
      - "echobase.role=ephemeral"
      - "echobase.env=devlocal"
      - "echobase.service=api-gateway"
    restart: unless-stopped
    # Healthcheck defined in Dockerfile (uses Node.js, more reliable)

  order-processor:
    container_name: echobase-devlocal-order-processor
    mem_limit: 256m
    cpus: 0.25
    build:
      context: ./backend
      dockerfile: order-processor/Dockerfile
      args:
        - GIT_SHORT_SHA=${GIT_SHORT_SHA:-unknown}
        - BUILD_DATE=${BUILD_DATE:-unknown}
    image: echobase-order-processor:latest
    env_file:
      - .env
      - .env.secrets
    environment:
      # Per-service overrides only — everything else comes from env_file
      - DB_CONNECTION_LIMIT=2
      - OTEL_SERVICE_NAME=order-processor
    depends_on:
      localstack:
        condition: service_healthy
    networks:
      - echobase-network
      - durable-network
    labels:
      - "echobase.role=ephemeral"
      - "echobase.env=devlocal"
      - "echobase.service=order-processor"
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "find /tmp/last-successful-poll -mmin -2 2>/dev/null | grep -q ." ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  frontend:
    container_name: echobase-devlocal-frontend
    init: true # Use tini as PID 1 so nginx doesn't reap health check processes (suppresses SIGCHLD noise)
    mem_limit: 256m
    cpus: 0.25
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - GIT_SHORT_SHA=${GIT_SHORT_SHA:-unknown}
        - BUILD_DATE=${BUILD_DATE:-unknown}
    image: echobase-frontend:latest
    env_file:
      - .env
      - .env.secrets
    environment:
      - VITE_API_URL=${VITE_API_URL}
      # API_GATEWAY_HOST controls which api-gateway container nginx proxies to.
      # Default 'api-gateway' works for devlocal (single api-gateway on network).
      # CI overrides this in blue.yml/green.yml to use explicit container names,
      # preventing DNS round-robin when both environments share the durable-network.
      - API_GATEWAY_HOST=api-gateway
      # OTEL Collector hostname for frontend nginx proxy (/v1/traces)
      - OTEL_COLLECTOR_HOST=echobase-devlocal-durable-otel-collector

      # AWS Configuration for fetching SSL secrets from durable LocalStack
      # AWS_ENDPOINT_URL is set per-environment (override.yml, blue.yml, green.yml)
      # to point to the durable LocalStack where SSL secrets are seeded.
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - SSL_SECRET_ID=echobase/frontend/ssl
    depends_on:
      api-gateway:
        condition: service_healthy
      localstack:
        condition: service_healthy
    networks:
      - echobase-network
      - durable-network # Required for nginx load balancer to reach frontend
    labels:
      - "echobase.role=ephemeral"
      - "echobase.env=devlocal"
      - "echobase.service=frontend"
    restart: unless-stopped
    # Healthcheck defined in Dockerfile (uses wget, more reliable)

volumes:
  localstack-data:


networks:
  echobase-network:
    driver: bridge
  durable-network:
    external: true
    name: echobase-devlocal-durable-network
