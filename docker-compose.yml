# IMPORTANT: This docker-compose.yml is for ephemeral blue-green deployments.
# The database is managed separately in durable/docker-compose.yml
# Before using this file, ensure the durable infrastructure is running:
#   ./durable/setup.sh devlocal

services:
  localstack:
    container_name: echobase-devlocal-localstack
    image: localstack/localstack:latest
    environment:
      - SERVICES=sqs,logs,iam,kms,secretsmanager
      - DEBUG=0
      - LS_LOG=warning
      - PERSISTENCE=1
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - "localstack-data:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
    networks:
      - echobase-network
    labels:
      - "echobase.role=ephemeral"
      - "echobase.env=devlocal"
      - "echobase.service=localstack"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:4566/_localstack/health"]
      interval: 5s
      timeout: 10s
      retries: 30
      start_period: 20s

  api-gateway:
    container_name: echobase-devlocal-api-gateway
    build:
      context: ./backend
      dockerfile: api-gateway/Dockerfile
      args:
        - GIT_SHORT_SHA=${GIT_SHORT_SHA:-unknown}
        - BUILD_DATE=${BUILD_DATE:-unknown}
    image: echobase-api-gateway:latest
    environment:
      - PORT=${PORT}
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - SQS_ENDPOINT=${SQS_ENDPOINT}
      - SQS_QUEUE_URL=${SQS_QUEUE_URL}
      - SECRETS_MANAGER_ENDPOINT=${SECRETS_MANAGER_ENDPOINT}
      - DB_SECRET_NAME=${DB_SECRET_NAME}
      - JWT_SECRET=${JWT_SECRET}
      # CORS_ORIGIN defined in environment-specific files (override.yml, blue.yml, green.yml)
      # Each environment needs different allowed origins (localhost ports, internal container names)
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS}
      - RATE_LIMIT_MAX_REQUESTS=${RATE_LIMIT_MAX_REQUESTS}
      - MCP_SERVER_ENDPOINT=${MCP_SERVER_ENDPOINT}
      - MCP_API_KEY=${MCP_API_KEY}
    depends_on:
      localstack:
        condition: service_healthy
    networks:
      - echobase-network
      - durable-network
    labels:
      - "echobase.role=ephemeral"
      - "echobase.env=devlocal"
      - "echobase.service=api-gateway"
    restart: unless-stopped
    # Healthcheck defined in Dockerfile (uses Node.js, more reliable)

  order-processor:
    container_name: echobase-devlocal-order-processor
    build:
      context: ./backend
      dockerfile: order-processor/Dockerfile
      args:
        - GIT_SHORT_SHA=${GIT_SHORT_SHA:-unknown}
        - BUILD_DATE=${BUILD_DATE:-unknown}
    image: echobase-order-processor:latest
    environment:
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - SQS_ENDPOINT=${SQS_ENDPOINT}
      - SQS_QUEUE_URL=${SQS_QUEUE_URL}
      - SECRETS_MANAGER_ENDPOINT=${SECRETS_MANAGER_ENDPOINT}
      - DB_SECRET_NAME=${DB_SECRET_NAME}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_NAME=${DB_NAME}
      - POLL_INTERVAL=${POLL_INTERVAL}
      - MAX_MESSAGES=${MAX_MESSAGES}
    depends_on:
      localstack:
        condition: service_healthy
    networks:
      - echobase-network
      - durable-network
    labels:
      - "echobase.role=ephemeral"
      - "echobase.env=devlocal"
      - "echobase.service=order-processor"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-f", "node"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 30s

  frontend:
    container_name: echobase-devlocal-frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - GIT_SHORT_SHA=${GIT_SHORT_SHA:-unknown}
        - BUILD_DATE=${BUILD_DATE:-unknown}
    image: echobase-frontend:latest
    environment:
      - REACT_APP_API_URL=${REACT_APP_API_URL}
      # API_GATEWAY_HOST controls which api-gateway container nginx proxies to.
      # Default 'api-gateway' works for devlocal (single api-gateway on network).
      # CI overrides this in blue.yml/green.yml to use explicit container names,
      # preventing DNS round-robin when both environments share the durable-network.
      - API_GATEWAY_HOST=api-gateway
    depends_on:
      api-gateway:
        condition: service_healthy
    networks:
      - echobase-network
      - durable-network  # Required for nginx load balancer to reach frontend
    labels:
      - "echobase.role=ephemeral"
      - "echobase.env=devlocal"
      - "echobase.service=frontend"
    restart: unless-stopped
    # Healthcheck defined in Dockerfile (uses wget, more reliable)

volumes:
  localstack-data:

networks:
  echobase-network:
    driver: bridge
  durable-network:
    external: true
    name: echobase-devlocal-durable-network
